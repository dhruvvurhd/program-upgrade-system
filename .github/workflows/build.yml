name: Build Solana Program

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: backpackapp/build:v0.29.0
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Fix Anchor.toml
      run: |
        sed -i '/\[toolchain\]/,/^$/d' Anchor.toml
        cat Anchor.toml

    - name: Build Program
      run: anchor build
        
    - name: Copy artifacts
      run: |
        mkdir -p artifacts
        cp target/deploy/*.so artifacts/ || echo "No .so files"
        ls -la target/deploy/ || true
        
    - uses: actions/upload-artifact@v4
      with:
        name: program-build
        path: |
          artifacts/*.so
          target/idl/*.json
